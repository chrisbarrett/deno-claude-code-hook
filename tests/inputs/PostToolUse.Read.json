{
  "session_id": "test-session-id",
  "transcript_path": "/test/project/.claude/transcripts/test-session.json",
  "cwd": "/test/project",
  "permission_mode": "bypassPermissions",
  "hook_event_name": "PostToolUse",
  "tool_name": "Read",
  "tool_input": {
    "file_path": "/test/project/mod.ts"
  },
  "tool_response": {
    "type": "text",
    "file": {
      "filePath": "/test/project/mod.ts",
      "content": "/**\n * Type-safe Deno library for building [Claude Code](https://code.claude.com) hooks\n * with runtime validation. Using this lib you can write self-contained hook\n * scripts with LSP completions and editor squiggles to guide you.\n *\n * ## Quick Start\n *\n * The example below will teach Claude Code to use the `say` command on macOS to\n * announce when it's compacting. The announcement is a bit terser if compaction\n * was user-initiated via `/compact`.\n *\n * ```typescript\n * #!/usr/bin/env -S deno run --allow-read --allow-run\n * import { preCompact } from \"jsr:@chrisbarrett/claude-code-hook\";\n * import $ from \"jsr:@david/dax\";\n *\n * preCompact(async (input) => {\n *   const message = input.trigger === \"auto\"\n *     ? \"Auto-compaction started\"\n *     : \"Compacting\";\n *\n *   await $`nohup -- say ${message}`;\n * });\n * ```\n *\n * Don't forget to `chmod +x`!\n *\n * **Configure in `~/.claude/settings.json`:**\n *\n * ```json\n * {\n *   \"hooks\": {\n *     \"PreCompact\": [\n *       {\n *         \"hooks\": [\n *           {\n *             \"type\": \"command\",\n *             \"command\": \"/path/to/your/script\"\n *           }\n *         ]\n *       }\n *     ]\n *   }\n * }\n * ```\n *\n * ## Environment Variables\n *\n * ### CLAUDE_CODE_HOOK_STDIN_MAX_BUF_LEN\n *\n * Controls the maximum buffer size for stdin reads (default: 10 MiB).\n *\n * **Example:**\n * ```bash\n * export CLAUDE_CODE_HOOK_STDIN_MAX_BUF_LEN=20971520  # 20 MiB\n * ```\n *\n * ### CLAUDE_ENV_FILE\n *\n * Available only in `SessionStart` hooks. Path to a file where environment\n * variables can be persisted for subsequent bash commands.\n *\n * Use the {@link persistEnvVar} helper to write to this file:\n *\n * ```typescript\n * import { persistEnvVar, sessionStart } from \"jsr:@chrisbarrett/claude-code-hook\";\n *\n * sessionStart(async (input) => {\n *   await persistEnvVar(\"MY_API_KEY\", \"secret-value\");\n *   // MY_API_KEY now available in all subsequent bash commands\n * });\n * ```\n *\n * ## Permission Requirements\n *\n * Hooks require explicit Deno permissions:\n *\n * - `--allow-read` - stdin operations (always required)\n * - `--allow-write` - file operations (e.g., {@link persistEnvVar})\n * - `--allow-env` - environment variable access\n *\n * The library gracefully handles missing permissions by returning defaults.\n *\n * @module\n * @see {@link https://code.claude.com/docs/en/hooks | Claude Code Hooks Documentation}\n */\nimport { z } from \"zod\";\nimport * as schemas from \"./schemas/hooks.ts\";\nimport { defineHook, type HookDef } from \"./define-hook.ts\";\nimport { claudeEnvFile } from \"./env.ts\";\n\n/**\n * Runs after Claude creates tool parameters and before processing the tool call.\n *\n * The result determines whether the tool call is allowed to proceed.\n * stdout is shown in the Ctrl-R transcript.\n *\n * @see {@link https://code.claude.com/docs/en/hooks#pretooluse | PreToolUse Hook Documentation}\n *\n * @example Block specific tools\n * ```typescript\n * import { preToolUse } from \"jsr:@chrisbarrett/claude-code-hook\";\n *\n * preToolUse(async (input) => {\n *   const blockedTools = [\"Write\", \"Edit\"];\n *\n *   if (blockedTools.includes(input.tool.tool_name)) {\n *     return {\n *       hookSpecificOutput: {\n *         hookEventName: \"PreToolUse\",\n *         shouldProceed: false,\n *         blockedMessage: `Tool ${input.tool.tool_name} not allowed in production`,\n *       },\n *     };\n *   }\n * });\n * ```\n *\n * @example Validate file paths\n * ```typescript\n * import { preToolUse } from \"jsr:@chrisbarrett/claude-code-hook\";\n *\n * preToolUse(async (input) => {\n *   if (input.tool.tool_name === \"Read\") {\n *     const filePath = input.tool.tool_input.file_path;\n *\n *     if (filePath.includes(\"secrets\")) {\n *       return {\n *         hookSpecificOutput: {\n *           hookEventName: \"PreToolUse\",\n *           shouldProceed: false,\n *           blockedMessage: \"Cannot read files in secrets directory\",\n *         },\n *       };\n *     }\n *   }\n * });\n * ```\n *\n * @example Add context before tool execution\n * ```typescript\n * import { preToolUse } from \"jsr:@chrisbarrett/claude-code-hook\";\n *\n * preToolUse(async (input) => {\n *   if (input.tool.tool_name === \"Bash\") {\n *     return {\n *       hookSpecificOutput: {\n *         hookEventName: \"PreToolUse\",\n *         additionalContext: \"Running in staging environment\",\n *       },\n *     };\n *   }\n * });\n * ```\n */\nexport const preToolUse: HookDef<\n  typeof schemas.preToolUseInput,\n  typeof schemas.preToolUseOutput\n> = defineHook(schemas.preToolUseInput, schemas.preToolUseOutput);\n\n/**\n * Runs immediately after a tool completes successfully.\n *\n * The result provides feedback to Claude after tool execution.\n * stdout is shown in the Ctrl-R transcript.\n *\n * @see {@link https://code.claude.com/docs/en/hooks#posttooluse | PostToolUse Hook Documentation}\n *\n * @example Check bash command exit codes\n * ```typescript\n * import { postToolUse } from \"jsr:@chrisbarrett/claude-code-hook\";\n *\n * postToolUse(async (input) => {\n *   if (input.tool.tool_name === \"Bash\") {\n *     const exitCode = input.tool.tool_response.exit_code;\n *\n *     if (exitCode !== 0) {\n *       return {\n *         hookSpecificOutput: {\n *           hookEventName: \"PostToolUse\",\n *           additionalContext: `Command failed with exit code ${exitCode}`,\n *         },\n *       };\n *     }\n *   }\n * });\n * ```\n *\n * @example Log file modifications\n * ```typescript\n * import { postToolUse } from \"jsr:@chrisbarrett/claude-code-hook\";\n *\n * postToolUse(async (input) => {\n *   if (input.tool.tool_name === \"Write\" || input.tool.tool_name === \"Edit\") {\n *     const filePath = input.tool.tool_input.file_path;\n *     console.log(`Modified: ${filePath}`);\n *   }\n * });\n * ```\n */\nexport const postToolUse: HookDef<\n  typeof schemas.postToolUseInput,\n  typeof schemas.postToolUseOutput\n> = defineHook(schemas.postToolUseInput, schemas.postToolUseOutput);\n\n/**\n * Runs when Claude Code sends notifications.\n *\n * Notifications are sent when:\n *\n * 1. Claude needs your permission to use a tool. Example: \"Claude needs your\n *    permission to use Bash\"\n *\n * 2. The prompt input has been idle for at least 60 seconds. \"Claude is\n *    waiting for your input\"\n *\n * stdout is only shown when Claude is run with `--debug`.\n *\n * @see {@link https://code.claude.com/docs/en/hooks#notification | Notification Hook Documentation}\n */\nexport const notification: HookDef<\n  typeof schemas.notificationInput,\n  typeof schemas.notificationOutput\n> = defineHook(schemas.notificationInput, schemas.notificationOutput);\n\n/**\n * Runs when the user submits a prompt, before Claude processes it.\n *\n * Allows you to add additional context based on the prompt/conversation,\n * validate prompts, or block certain types of prompts.\n *\n * If blocked, the submitted prompt is erased from the context.\n * stdout is added as context for Claude.\n *\n * @see {@link https://code.claude.com/docs/en/hooks#userpromptsubmit | UserPromptSubmit Hook Documentation}\n *\n * @example Add dynamic context based on working directory\n * ```typescript\n * import { userPromptSubmit } from \"jsr:@chrisbarrett/claude-code-hook\";\n *\n * userPromptSubmit(async (input) => {\n *   const isTestDir = input.workingDirectory.includes(\"/tests/\");\n *\n *   if (isTestDir) {\n *     return {\n *       hookSpecificOutput: {\n *         hookEventName: \"UserPromptSubmit\",\n *         additionalContext: \"You are working in the tests directory. Prioritize test-related suggestions.\",\n *       },\n *     };\n *   }\n * });\n * ```\n *\n * @example Block prompts containing sensitive patterns\n * ```typescript\n * import { userPromptSubmit } from \"jsr:@chrisbarrett/claude-code-hook\";\n *\n * userPromptSubmit(async (input) => {\n *   const prompt = input.prompt.toLowerCase();\n *\n *   if (prompt.includes(\"delete production\") || prompt.includes(\"drop database\")) {\n *     return {\n *       hookSpecificOutput: {\n *         hookEventName: \"UserPromptSubmit\",\n *         shouldProceed: false,\n *         blockedMessage: \"Dangerous operations blocked in production environment\",\n *       },\n *     };\n *   }\n * });\n * ```\n */\nexport const userPromptSubmit: HookDef<\n  typeof schemas.userPromptSubmitInput,\n  typeof schemas.userPromptSubmitOutput\n> = defineHook(schemas.userPromptSubmitInput, schemas.userPromptSubmitOutput);\n\n/** A general-purpose hook that can be used for any event.\n */\nexport const generic: HookDef<\n  typeof schemas.genericInput,\n  typeof schemas.genericOutput\n> = defineHook(schemas.genericInput, schemas.genericOutput);\n\n/**\n * Runs when the main Claude Code agent has finished responding. The output\n * controls whether Claude must continue.\n *\n * Does not run if the stoppage occurred due to a user interrupt.\n *\n * stdout is shown in the Ctrl-R transcript.\n *\n * @see {@link https://code.claude.com/docs/en/hooks#stop | Stop Hook Documentation}\n */\nexport const stop: HookDef<\n  typeof schemas.stopInput,\n  typeof schemas.stopOutput\n> = defineHook(schemas.stopInput, schemas.stopOutput);\n\n/**\n * Runs when a Claude Code subagent (Task tool call) has finished responding.\n * The output controls whether Claude must continue.\n *\n * It is not documented whether this is run when a user interrupts a subagent.\n *\n * stdout is shown in the Ctrl-R transcript.\n *\n * @see {@link https://code.claude.com/docs/en/hooks#subagentstop | SubagentStop Hook Documentation}\n */\nexport const subagentStop: HookDef<\n  typeof schemas.subagentStopInput,\n  typeof schemas.subagentStopOutput\n> = defineHook(schemas.subagentStopInput, schemas.subagentStopOutput);\n\n/**\n * Runs before Claude Code is about to run a compact operation.\n *\n * Compaction may be initiated by the user via the `/compact` command, or it\n * may be initiated automatically by Claude Code when context limits are\n * reached.\n *\n * @see {@link https://code.claude.com/docs/en/hooks#precompact | PreCompact Hook Documentation}\n */\nexport const preCompact: HookDef<\n  typeof schemas.preCompactInput,\n  typeof schemas.preCompactOutput\n> = defineHook(schemas.preCompactInput, schemas.preCompactOutput);\n\n/**\n * Runs when Claude Code starts a new session or resumes an existing session.\n *\n * Useful for loading development context like existing issues or recent changes,\n * installing dependencies, or setting up environment variables.\n *\n * SessionStart hooks have access to {@link CLAUDE_ENV_FILE}, which provides a\n * file path where you can persist environment variables for subsequent bash commands.\n *\n * stdout is added as context for Claude.\n *\n * @see {@link https://code.claude.com/docs/en/hooks#sessionstart | SessionStart Hook Documentation}\n *\n * @example Load git context\n * ```typescript\n * import { sessionStart } from \"jsr:@chrisbarrett/claude-code-hook\";\n *\n * sessionStart(async (input) => {\n *   const decoder = new TextDecoder();\n *   const gitBranch = new Deno.Command(\"git\", {\n *     args: [\"branch\", \"--show-current\"],\n *     cwd: input.workingDirectory,\n *   });\n *   const { stdout } = await gitBranch.output();\n *   const branch = decoder.decode(stdout).trim();\n *\n *   return {\n *     hookSpecificOutput: {\n *       hookEventName: \"SessionStart\",\n *       additionalContext: `Current git branch: ${branch}`,\n *     },\n *   };\n * });\n * ```\n *\n * @example Set environment variables for bash commands\n * ```typescript\n * import { persistEnvVar, sessionStart } from \"jsr:@chrisbarrett/claude-code-hook\";\n *\n * sessionStart(async (input) => {\n *   await persistEnvVar(\"NODE_ENV\", \"development\");\n *   await persistEnvVar(\"API_URL\", \"https://staging.example.com\");\n *\n *   return {\n *     hookSpecificOutput: {\n *       hookEventName: \"SessionStart\",\n *       additionalContext: \"Environment configured for staging\",\n *     },\n *   };\n * });\n * ```\n *\n * @example Load issue tracking context\n * ```typescript\n * import { sessionStart } from \"jsr:@chrisbarrett/claude-code-hook\";\n *\n * sessionStart(async (input) => {\n *   // Fetch open issues from tracking system\n *   const response = await fetch(\"https://api.example.com/issues?status=open\");\n *   const issues = await response.json();\n *\n *   const issueList = issues.map((i) => `- ${i.id}: ${i.title}`).join(\"\\n\");\n *\n *   return {\n *     hookSpecificOutput: {\n *       hookEventName: \"SessionStart\",\n *       additionalContext: `Open issues:\\n${issueList}`,\n *     },\n *   };\n * });\n * ```\n */\nexport const sessionStart: HookDef<\n  typeof schemas.sessionStartInput,\n  typeof schemas.sessionStartOutput\n> = defineHook(schemas.sessionStartInput, schemas.sessionStartOutput);\n\n/**\n * Persist an environment variable to {@link CLAUDE_ENV_FILE}.\n *\n * Makes the environment variable available in all subsequent bash commands\n * executed by Claude Code during the session.\n *\n * **Permissions required:**\n * - `--allow-env` - to read CLAUDE_ENV_FILE path\n * - `--allow-write` - to write to the environment file\n *\n * **Only available in `SessionStart` hooks.**\n *\n * @param name - Environment variable name (must match POSIX: [a-zA-Z_][a-zA-Z0-9_]*)\n * @param value - Environment variable value (automatically escaped for shell safety)\n *\n * @throws {Error} If name is invalid or CLAUDE_ENV_FILE is not set\n *\n * @example Basic usage\n * ```typescript\n * import { persistEnvVar, sessionStart } from \"jsr:@chrisbarrett/claude-code-hook\";\n *\n * sessionStart(async (input) => {\n *   await persistEnvVar(\"DATABASE_URL\", \"postgresql://localhost/mydb\");\n *   await persistEnvVar(\"LOG_LEVEL\", \"debug\");\n * });\n * ```\n *\n * @example Conditional environment setup\n * ```typescript\n * import { persistEnvVar, sessionStart } from \"jsr:@chrisbarrett/claude-code-hook\";\n *\n * sessionStart(async (input) => {\n *   const isProduction = input.workingDirectory.includes(\"/production/\");\n *\n *   if (isProduction) {\n *     await persistEnvVar(\"NODE_ENV\", \"production\");\n *     await persistEnvVar(\"API_URL\", \"https://api.example.com\");\n *   } else {\n *     await persistEnvVar(\"NODE_ENV\", \"development\");\n *     await persistEnvVar(\"API_URL\", \"https://staging.example.com\");\n *   }\n * });\n * ```\n */\nexport const persistEnvVar = async (\n  name: string,\n  value: string,\n): Promise<void> => {\n  // Validate environment variable name per POSIX spec\n  // Must start with letter or underscore, followed by letters, digits, or underscores\n  const parsedName = z\n    .string()\n    .regex(/^[a-zA-Z_][a-zA-Z0-9_]*$/)\n    .describe(\"Environment variable name\")\n    .parse(name);\n\n  // Escape value for safe use in single-quoted shell strings\n  // Single quotes are literal in bash - only need to escape single quotes themselves\n  // Replace ' with '\\'' (end quote, escaped quote, start quote)\n  const escapedValue = value.replace(/'/g, \"'\\\\''\");\n\n  const file = claudeEnvFile();\n  const encoder = new TextEncoder();\n  const line = encoder.encode(`export ${parsedName}='${escapedValue}'\\n`);\n\n  await Deno.writeFile(file, line, { append: true, create: true });\n};\n\n/**\n * Runs when a Claude Code session ends. Useful for cleanup tasks, logging\n * session statistics, or saving session state.\n *\n * stdout is only shown when Claude is run with `--debug`.\n *\n * @see {@link https://code.claude.com/docs/en/hooks#sessionend | SessionEnd Hook Documentation}\n */\nexport const sessionEnd: HookDef<\n  typeof schemas.sessionEndInput,\n  typeof schemas.sessionEndOutput\n> = defineHook(schemas.sessionEndInput, schemas.sessionEndOutput);\n",
      "numLines": 487,
      "startLine": 1,
      "totalLines": 487
    }
  }
}
