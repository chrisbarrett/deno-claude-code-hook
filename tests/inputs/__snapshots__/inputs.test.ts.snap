export const snapshot = {};

snapshot[`parse SessionEnd.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "SessionEnd",
  reason: "other",
  session_id: "test-session-id",
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
}
`;

snapshot[`parse SessionStart.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "SessionStart",
  session_id: "test-session-id",
  source: "startup",
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
}
`;

snapshot[`parse Stop.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "Stop",
  permission_mode: "acceptEdits",
  session_id: "test-session-id",
  stop_hook_active: false,
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
}
`;

snapshot[`parse UserPromptSubmit.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "UserPromptSubmit",
  permission_mode: "acceptEdits",
  prompt: "What is 2+2?",
  session_id: "test-session-id",
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
}
`;

snapshot[`parse PreToolUse.Read.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "PreToolUse",
  permission_mode: "bypassPermissions",
  session_id: "test-session-id",
  tool_input: {
    file_path: "/test/project/mod.ts",
  },
  tool_name: "Read",
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
  type: "Read",
}
`;

snapshot[`parse PreToolUse.Write.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "PreToolUse",
  permission_mode: "bypassPermissions",
  session_id: "test-session-id",
  tool_input: {
    content: "test data",
    file_path: "/tmp/test-write-output.txt",
  },
  tool_name: "Write",
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
  type: "Write",
}
`;

snapshot[`parse PreToolUse.Edit.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "PreToolUse",
  permission_mode: "bypassPermissions",
  session_id: "test-session-id",
  tool_input: {
    file_path: "/tmp/test-edit-target.json",
    new_string: '"world"',
    old_string: '"hello"',
  },
  tool_name: "Edit",
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
  type: "Edit",
}
`;

snapshot[`parse PreToolUse.Glob.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "PreToolUse",
  permission_mode: "bypassPermissions",
  session_id: "test-session-id",
  tool_input: {
    pattern: "**/*.ts",
  },
  tool_name: "Glob",
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
  type: "Glob",
}
`;

snapshot[`parse PreToolUse.Bash.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "PreToolUse",
  permission_mode: "bypassPermissions",
  session_id: "test-session-id",
  tool_input: {
    command: "pwd",
    description: "Print working directory",
  },
  tool_name: "Bash",
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
  type: "Bash",
}
`;

snapshot[`parse PreToolUse.Grep.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "PreToolUse",
  permission_mode: "bypassPermissions",
  session_id: "test-session-id",
  tool_input: {
    pattern: "export",
  },
  tool_name: "Grep",
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
  type: "Grep",
}
`;

snapshot[`parse PreToolUse.Task.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "PreToolUse",
  permission_mode: "bypassPermissions",
  session_id: "test-session-id",
  tool_input: {
    description: "test task",
    model: "haiku",
    prompt: "What is 2+2?",
    subagent_type: "general-purpose",
  },
  tool_name: "Task",
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
  type: "Task",
}
`;

snapshot[`parse PreToolUse.NotebookEdit.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "PreToolUse",
  permission_mode: "bypassPermissions",
  session_id: "test-session-id",
  tool_input: {
    cell_id: "test-cell-1",
    new_source: "print(1)",
    notebook_path: "/tmp/test-notebook-edit.ipynb",
  },
  tool_name: "NotebookEdit",
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
  type: "NotebookEdit",
}
`;

snapshot[`parse PreToolUse.TodoWrite.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "PreToolUse",
  permission_mode: "bypassPermissions",
  session_id: "test-session-id",
  tool_input: {
    todos: [
      {
        activeForm: "Testing task",
        content: "test task",
        status: "pending",
      },
    ],
  },
  tool_name: "TodoWrite",
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
  type: "TodoWrite",
}
`;

snapshot[`parse PreToolUse.WebFetch.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "PreToolUse",
  permission_mode: "bypassPermissions",
  session_id: "test-session-id",
  tool_input: {
    prompt: "extract the page title",
    url: "https://example.com",
  },
  tool_name: "WebFetch",
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
  type: "WebFetch",
}
`;

snapshot[`parse PreToolUse.WebSearch.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "PreToolUse",
  permission_mode: "bypassPermissions",
  session_id: "test-session-id",
  tool_input: {
    query: "Claude Code hooks documentation",
  },
  tool_name: "WebSearch",
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
  type: "WebSearch",
}
`;

snapshot[`parse PreToolUse.SlashCommand.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "PreToolUse",
  permission_mode: "bypassPermissions",
  session_id: "test-session-id",
  tool_input: {
    command: "/test-command",
  },
  tool_name: "SlashCommand",
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
  type: "SlashCommand",
}
`;

snapshot[`parse PreToolUse.BashOutput.json 1`] = `
{
  cwd: "/Users/chris/src/chrisbarrett/deno-claude-code-hook",
  hook_event_name: "PreToolUse",
  permission_mode: "bypassPermissions",
  session_id: "b6e655f9-604a-4c74-b08d-c6231a11a4ed",
  tool_input: {
    bash_id: "c26bed",
  },
  tool_name: "BashOutput",
  transcript_path: "/Users/chris/.claude/projects/-Users-chris-src-chrisbarrett-deno-claude-code-hook/b6e655f9-604a-4c74-b08d-c6231a11a4ed.jsonl",
  type: "BashOutput",
}
`;

snapshot[`parse PreToolUse.KillShell.json 1`] = `
{
  cwd: "/Users/chris/src/chrisbarrett/deno-claude-code-hook",
  hook_event_name: "PreToolUse",
  permission_mode: "bypassPermissions",
  session_id: "b6e655f9-604a-4c74-b08d-c6231a11a4ed",
  tool_input: {
    shell_id: "c26bed",
  },
  tool_name: "KillShell",
  transcript_path: "/Users/chris/.claude/projects/-Users-chris-src-chrisbarrett-deno-claude-code-hook/b6e655f9-604a-4c74-b08d-c6231a11a4ed.jsonl",
  type: "KillShell",
}
`;

snapshot[`parse PostToolUse.Read.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "PostToolUse",
  permission_mode: "bypassPermissions",
  session_id: "test-session-id",
  tool_input: {
    file_path: "/test/project/mod.ts",
  },
  tool_name: "Read",
  tool_response: {
    file: {
      content: "/**
 * Type-safe Deno library for building [Claude Code](https://code.claude.com) hooks
 * with runtime validation. Using this lib you can write self-contained hook
 * scripts with LSP completions and editor squiggles to guide you.
 *
 * ## Quick Start
 *
 * The example below will teach Claude Code to use the \`say\` command on macOS to
 * announce when it's compacting. The announcement is a bit terser if compaction
 * was user-initiated via \`/compact\`.
 *
 * \`\`\`typescript
 * #!/usr/bin/env -S deno run --allow-read --allow-run
 * import { preCompact } from \\"jsr:@chrisbarrett/claude-code-hook\\";
 * import \$ from \\"jsr:@david/dax\\";
 *
 * preCompact(async (input) => {
 *   const message = input.trigger === \\"auto\\"
 *     ? \\"Auto-compaction started\\"
 *     : \\"Compacting\\";
 *
 *   await \$\`nohup -- say \${message}\`;
 * });
 * \`\`\`
 *
 * Don't forget to \`chmod +x\`!
 *
 * **Configure in \`~/.claude/settings.json\`:**
 *
 * \`\`\`json
 * {
 *   \\"hooks\\": {
 *     \\"PreCompact\\": [
 *       {
 *         \\"hooks\\": [
 *           {
 *             \\"type\\": \\"command\\",
 *             \\"command\\": \\"/path/to/your/script\\"
 *           }
 *         ]
 *       }
 *     ]
 *   }
 * }
 * \`\`\`
 *
 * ## Environment Variables
 *
 * ### CLAUDE_CODE_HOOK_STDIN_MAX_BUF_LEN
 *
 * Controls the maximum buffer size for stdin reads (default: 10 MiB).
 *
 * **Example:**
 * \`\`\`bash
 * export CLAUDE_CODE_HOOK_STDIN_MAX_BUF_LEN=20971520  # 20 MiB
 * \`\`\`
 *
 * ### CLAUDE_ENV_FILE
 *
 * Available only in \`SessionStart\` hooks. Path to a file where environment
 * variables can be persisted for subsequent bash commands.
 *
 * Use the {@link persistEnvVar} helper to write to this file:
 *
 * \`\`\`typescript
 * import { persistEnvVar, sessionStart } from \\"jsr:@chrisbarrett/claude-code-hook\\";
 *
 * sessionStart(async (input) => {
 *   await persistEnvVar(\\"MY_API_KEY\\", \\"secret-value\\");
 *   // MY_API_KEY now available in all subsequent bash commands
 * });
 * \`\`\`
 *
 * ## Permission Requirements
 *
 * Hooks require explicit Deno permissions:
 *
 * - \`--allow-read\` - stdin operations (always required)
 * - \`--allow-write\` - file operations (e.g., {@link persistEnvVar})
 * - \`--allow-env\` - environment variable access
 *
 * The library gracefully handles missing permissions by returning defaults.
 *
 * @module
 * @see {@link https://code.claude.com/docs/en/hooks | Claude Code Hooks Documentation}
 */
import { z } from \\"zod\\";
import * as schemas from \\"./schemas/hooks.ts\\";
import { defineHook, type HookDef } from \\"./define-hook.ts\\";
import { claudeEnvFile } from \\"./env.ts\\";

/**
 * Runs after Claude creates tool parameters and before processing the tool call.
 *
 * The result determines whether the tool call is allowed to proceed.
 * stdout is shown in the Ctrl-R transcript.
 *
 * @see {@link https://code.claude.com/docs/en/hooks#pretooluse | PreToolUse Hook Documentation}
 *
 * @example Block specific tools
 * \`\`\`typescript
 * import { preToolUse } from \\"jsr:@chrisbarrett/claude-code-hook\\";
 *
 * preToolUse(async (input) => {
 *   const blockedTools = [\\"Write\\", \\"Edit\\"];
 *
 *   if (blockedTools.includes(input.tool.tool_name)) {
 *     return {
 *       hookSpecificOutput: {
 *         hookEventName: \\"PreToolUse\\",
 *         shouldProceed: false,
 *         blockedMessage: \`Tool \${input.tool.tool_name} not allowed in production\`,
 *       },
 *     };
 *   }
 * });
 * \`\`\`
 *
 * @example Validate file paths
 * \`\`\`typescript
 * import { preToolUse } from \\"jsr:@chrisbarrett/claude-code-hook\\";
 *
 * preToolUse(async (input) => {
 *   if (input.tool.tool_name === \\"Read\\") {
 *     const filePath = input.tool.tool_input.file_path;
 *
 *     if (filePath.includes(\\"secrets\\")) {
 *       return {
 *         hookSpecificOutput: {
 *           hookEventName: \\"PreToolUse\\",
 *           shouldProceed: false,
 *           blockedMessage: \\"Cannot read files in secrets directory\\",
 *         },
 *       };
 *     }
 *   }
 * });
 * \`\`\`
 *
 * @example Add context before tool execution
 * \`\`\`typescript
 * import { preToolUse } from \\"jsr:@chrisbarrett/claude-code-hook\\";
 *
 * preToolUse(async (input) => {
 *   if (input.tool.tool_name === \\"Bash\\") {
 *     return {
 *       hookSpecificOutput: {
 *         hookEventName: \\"PreToolUse\\",
 *         additionalContext: \\"Running in staging environment\\",
 *       },
 *     };
 *   }
 * });
 * \`\`\`
 */
export const preToolUse: HookDef<
  typeof schemas.preToolUseInput,
  typeof schemas.preToolUseOutput
> = defineHook(schemas.preToolUseInput, schemas.preToolUseOutput);

/**
 * Runs immediately after a tool completes successfully.
 *
 * The result provides feedback to Claude after tool execution.
 * stdout is shown in the Ctrl-R transcript.
 *
 * @see {@link https://code.claude.com/docs/en/hooks#posttooluse | PostToolUse Hook Documentation}
 *
 * @example Check bash command exit codes
 * \`\`\`typescript
 * import { postToolUse } from \\"jsr:@chrisbarrett/claude-code-hook\\";
 *
 * postToolUse(async (input) => {
 *   if (input.tool.tool_name === \\"Bash\\") {
 *     const exitCode = input.tool.tool_response.exit_code;
 *
 *     if (exitCode !== 0) {
 *       return {
 *         hookSpecificOutput: {
 *           hookEventName: \\"PostToolUse\\",
 *           additionalContext: \`Command failed with exit code \${exitCode}\`,
 *         },
 *       };
 *     }
 *   }
 * });
 * \`\`\`
 *
 * @example Log file modifications
 * \`\`\`typescript
 * import { postToolUse } from \\"jsr:@chrisbarrett/claude-code-hook\\";
 *
 * postToolUse(async (input) => {
 *   if (input.tool.tool_name === \\"Write\\" || input.tool.tool_name === \\"Edit\\") {
 *     const filePath = input.tool.tool_input.file_path;
 *     console.log(\`Modified: \${filePath}\`);
 *   }
 * });
 * \`\`\`
 */
export const postToolUse: HookDef<
  typeof schemas.postToolUseInput,
  typeof schemas.postToolUseOutput
> = defineHook(schemas.postToolUseInput, schemas.postToolUseOutput);

/**
 * Runs when Claude Code sends notifications.
 *
 * Notifications are sent when:
 *
 * 1. Claude needs your permission to use a tool. Example: \\"Claude needs your
 *    permission to use Bash\\"
 *
 * 2. The prompt input has been idle for at least 60 seconds. \\"Claude is
 *    waiting for your input\\"
 *
 * stdout is only shown when Claude is run with \`--debug\`.
 *
 * @see {@link https://code.claude.com/docs/en/hooks#notification | Notification Hook Documentation}
 */
export const notification: HookDef<
  typeof schemas.notificationInput,
  typeof schemas.notificationOutput
> = defineHook(schemas.notificationInput, schemas.notificationOutput);

/**
 * Runs when the user submits a prompt, before Claude processes it.
 *
 * Allows you to add additional context based on the prompt/conversation,
 * validate prompts, or block certain types of prompts.
 *
 * If blocked, the submitted prompt is erased from the context.
 * stdout is added as context for Claude.
 *
 * @see {@link https://code.claude.com/docs/en/hooks#userpromptsubmit | UserPromptSubmit Hook Documentation}
 *
 * @example Add dynamic context based on working directory
 * \`\`\`typescript
 * import { userPromptSubmit } from \\"jsr:@chrisbarrett/claude-code-hook\\";
 *
 * userPromptSubmit(async (input) => {
 *   const isTestDir = input.workingDirectory.includes(\\"/tests/\\");
 *
 *   if (isTestDir) {
 *     return {
 *       hookSpecificOutput: {
 *         hookEventName: \\"UserPromptSubmit\\",
 *         additionalContext: \\"You are working in the tests directory. Prioritize test-related suggestions.\\",
 *       },
 *     };
 *   }
 * });
 * \`\`\`
 *
 * @example Block prompts containing sensitive patterns
 * \`\`\`typescript
 * import { userPromptSubmit } from \\"jsr:@chrisbarrett/claude-code-hook\\";
 *
 * userPromptSubmit(async (input) => {
 *   const prompt = input.prompt.toLowerCase();
 *
 *   if (prompt.includes(\\"delete production\\") || prompt.includes(\\"drop database\\")) {
 *     return {
 *       hookSpecificOutput: {
 *         hookEventName: \\"UserPromptSubmit\\",
 *         shouldProceed: false,
 *         blockedMessage: \\"Dangerous operations blocked in production environment\\",
 *       },
 *     };
 *   }
 * });
 * \`\`\`
 */
export const userPromptSubmit: HookDef<
  typeof schemas.userPromptSubmitInput,
  typeof schemas.userPromptSubmitOutput
> = defineHook(schemas.userPromptSubmitInput, schemas.userPromptSubmitOutput);

/** A general-purpose hook that can be used for any event.
 */
export const generic: HookDef<
  typeof schemas.genericInput,
  typeof schemas.genericOutput
> = defineHook(schemas.genericInput, schemas.genericOutput);

/**
 * Runs when the main Claude Code agent has finished responding. The output
 * controls whether Claude must continue.
 *
 * Does not run if the stoppage occurred due to a user interrupt.
 *
 * stdout is shown in the Ctrl-R transcript.
 *
 * @see {@link https://code.claude.com/docs/en/hooks#stop | Stop Hook Documentation}
 */
export const stop: HookDef<
  typeof schemas.stopInput,
  typeof schemas.stopOutput
> = defineHook(schemas.stopInput, schemas.stopOutput);

/**
 * Runs when a Claude Code subagent (Task tool call) has finished responding.
 * The output controls whether Claude must continue.
 *
 * It is not documented whether this is run when a user interrupts a subagent.
 *
 * stdout is shown in the Ctrl-R transcript.
 *
 * @see {@link https://code.claude.com/docs/en/hooks#subagentstop | SubagentStop Hook Documentation}
 */
export const subagentStop: HookDef<
  typeof schemas.subagentStopInput,
  typeof schemas.subagentStopOutput
> = defineHook(schemas.subagentStopInput, schemas.subagentStopOutput);

/**
 * Runs before Claude Code is about to run a compact operation.
 *
 * Compaction may be initiated by the user via the \`/compact\` command, or it
 * may be initiated automatically by Claude Code when context limits are
 * reached.
 *
 * @see {@link https://code.claude.com/docs/en/hooks#precompact | PreCompact Hook Documentation}
 */
export const preCompact: HookDef<
  typeof schemas.preCompactInput,
  typeof schemas.preCompactOutput
> = defineHook(schemas.preCompactInput, schemas.preCompactOutput);

/**
 * Runs when Claude Code starts a new session or resumes an existing session.
 *
 * Useful for loading development context like existing issues or recent changes,
 * installing dependencies, or setting up environment variables.
 *
 * SessionStart hooks have access to {@link CLAUDE_ENV_FILE}, which provides a
 * file path where you can persist environment variables for subsequent bash commands.
 *
 * stdout is added as context for Claude.
 *
 * @see {@link https://code.claude.com/docs/en/hooks#sessionstart | SessionStart Hook Documentation}
 *
 * @example Load git context
 * \`\`\`typescript
 * import { sessionStart } from \\"jsr:@chrisbarrett/claude-code-hook\\";
 *
 * sessionStart(async (input) => {
 *   const decoder = new TextDecoder();
 *   const gitBranch = new Deno.Command(\\"git\\", {
 *     args: [\\"branch\\", \\"--show-current\\"],
 *     cwd: input.workingDirectory,
 *   });
 *   const { stdout } = await gitBranch.output();
 *   const branch = decoder.decode(stdout).trim();
 *
 *   return {
 *     hookSpecificOutput: {
 *       hookEventName: \\"SessionStart\\",
 *       additionalContext: \`Current git branch: \${branch}\`,
 *     },
 *   };
 * });
 * \`\`\`
 *
 * @example Set environment variables for bash commands
 * \`\`\`typescript
 * import { persistEnvVar, sessionStart } from \\"jsr:@chrisbarrett/claude-code-hook\\";
 *
 * sessionStart(async (input) => {
 *   await persistEnvVar(\\"NODE_ENV\\", \\"development\\");
 *   await persistEnvVar(\\"API_URL\\", \\"https://staging.example.com\\");
 *
 *   return {
 *     hookSpecificOutput: {
 *       hookEventName: \\"SessionStart\\",
 *       additionalContext: \\"Environment configured for staging\\",
 *     },
 *   };
 * });
 * \`\`\`
 *
 * @example Load issue tracking context
 * \`\`\`typescript
 * import { sessionStart } from \\"jsr:@chrisbarrett/claude-code-hook\\";
 *
 * sessionStart(async (input) => {
 *   // Fetch open issues from tracking system
 *   const response = await fetch(\\"https://api.example.com/issues?status=open\\");
 *   const issues = await response.json();
 *
 *   const issueList = issues.map((i) => \`- \${i.id}: \${i.title}\`).join(\\"\\\\n\\");
 *
 *   return {
 *     hookSpecificOutput: {
 *       hookEventName: \\"SessionStart\\",
 *       additionalContext: \`Open issues:\\\\n\${issueList}\`,
 *     },
 *   };
 * });
 * \`\`\`
 */
export const sessionStart: HookDef<
  typeof schemas.sessionStartInput,
  typeof schemas.sessionStartOutput
> = defineHook(schemas.sessionStartInput, schemas.sessionStartOutput);

/**
 * Persist an environment variable to {@link CLAUDE_ENV_FILE}.
 *
 * Makes the environment variable available in all subsequent bash commands
 * executed by Claude Code during the session.
 *
 * **Permissions required:**
 * - \`--allow-env\` - to read CLAUDE_ENV_FILE path
 * - \`--allow-write\` - to write to the environment file
 *
 * **Only available in \`SessionStart\` hooks.**
 *
 * @param name - Environment variable name (must match POSIX: [a-zA-Z_][a-zA-Z0-9_]*)
 * @param value - Environment variable value (automatically escaped for shell safety)
 *
 * @throws {Error} If name is invalid or CLAUDE_ENV_FILE is not set
 *
 * @example Basic usage
 * \`\`\`typescript
 * import { persistEnvVar, sessionStart } from \\"jsr:@chrisbarrett/claude-code-hook\\";
 *
 * sessionStart(async (input) => {
 *   await persistEnvVar(\\"DATABASE_URL\\", \\"postgresql://localhost/mydb\\");
 *   await persistEnvVar(\\"LOG_LEVEL\\", \\"debug\\");
 * });
 * \`\`\`
 *
 * @example Conditional environment setup
 * \`\`\`typescript
 * import { persistEnvVar, sessionStart } from \\"jsr:@chrisbarrett/claude-code-hook\\";
 *
 * sessionStart(async (input) => {
 *   const isProduction = input.workingDirectory.includes(\\"/production/\\");
 *
 *   if (isProduction) {
 *     await persistEnvVar(\\"NODE_ENV\\", \\"production\\");
 *     await persistEnvVar(\\"API_URL\\", \\"https://api.example.com\\");
 *   } else {
 *     await persistEnvVar(\\"NODE_ENV\\", \\"development\\");
 *     await persistEnvVar(\\"API_URL\\", \\"https://staging.example.com\\");
 *   }
 * });
 * \`\`\`
 */
export const persistEnvVar = async (
  name: string,
  value: string,
): Promise<void> => {
  // Validate environment variable name per POSIX spec
  // Must start with letter or underscore, followed by letters, digits, or underscores
  const parsedName = z
    .string()
    .regex(/^[a-zA-Z_][a-zA-Z0-9_]*\$/)
    .describe(\\"Environment variable name\\")
    .parse(name);

  // Escape value for safe use in single-quoted shell strings
  // Single quotes are literal in bash - only need to escape single quotes themselves
  // Replace ' with '\\\\'' (end quote, escaped quote, start quote)
  const escapedValue = value.replace(/'/g, \\"'\\\\\\\\''\\");

  const file = claudeEnvFile();
  const encoder = new TextEncoder();
  const line = encoder.encode(\`export \${parsedName}='\${escapedValue}'\\\\n\`);

  await Deno.writeFile(file, line, { append: true, create: true });
};

/**
 * Runs when a Claude Code session ends. Useful for cleanup tasks, logging
 * session statistics, or saving session state.
 *
 * stdout is only shown when Claude is run with \`--debug\`.
 *
 * @see {@link https://code.claude.com/docs/en/hooks#sessionend | SessionEnd Hook Documentation}
 */
export const sessionEnd: HookDef<
  typeof schemas.sessionEndInput,
  typeof schemas.sessionEndOutput
> = defineHook(schemas.sessionEndInput, schemas.sessionEndOutput);
",
      filePath: "/test/project/mod.ts",
      numLines: 487,
      startLine: 1,
      totalLines: 487,
    },
    type: "text",
  },
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
  type: "Read",
}
`;

snapshot[`parse PostToolUse.Write.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "PostToolUse",
  permission_mode: "bypassPermissions",
  session_id: "test-session-id",
  tool_input: {
    content: "test data",
    file_path: "/tmp/test-write-output.txt",
  },
  tool_name: "Write",
  tool_response: {
    content: "test data",
    filePath: "/tmp/test-write-output.txt",
    structuredPatch: [],
    type: "create",
  },
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
  type: "Write",
}
`;

snapshot[`parse PostToolUse.Edit.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "PostToolUse",
  permission_mode: "bypassPermissions",
  session_id: "test-session-id",
  tool_input: {
    file_path: "/tmp/test-edit-target.json",
    new_string: '"world"',
    old_string: '"hello"',
  },
  tool_name: "Edit",
  tool_response: {
    filePath: "/tmp/test-edit-target.json",
    newString: '"world"',
    oldString: '"hello"',
    originalFile: '{"greeting": "hello"}
',
    replaceAll: false,
    structuredPatch: [
      {
        lines: [
          '-{"greeting": "hello"}',
          '+{"greeting": "world"}',
        ],
        newLines: 1,
        newStart: 1,
        oldLines: 1,
        oldStart: 1,
      },
    ],
    userModified: false,
  },
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
  type: "Edit",
}
`;

snapshot[`parse PostToolUse.Glob.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "PostToolUse",
  permission_mode: "bypassPermissions",
  session_id: "test-session-id",
  tool_input: {
    pattern: "**/*.ts",
  },
  tool_name: "Glob",
  tool_response: {
    durationMs: 11,
    filenames: [
      "/test/project/env.ts",
      "/test/project/tests/pre-compact.test.ts",
      "/test/project/tests/notification.test.ts",
      "/test/project/tests/session-end.test.ts",
      "/test/project/tests/hooks/pre-tool-use.ts",
      "/test/project/tests/hooks/session-start.ts",
      "/test/project/tests/hooks/stop.ts",
      "/test/project/tests/hooks/session-end.ts",
      "/test/project/tests/hooks/user-prompt-submit.ts",
      "/test/project/tests/hooks/subagent-stop.ts",
      "/test/project/tests/hooks/notification.ts",
      "/test/project/tests/hooks/pre-compact.ts",
      "/test/project/mod.test.ts",
      "/test/project/define-hook.ts",
      "/test/project/testing.ts",
      "/test/project/tests/session-start.test.ts",
      "/test/project/tests/subagent-stop.test.ts",
      "/test/project/mod.ts",
      "/test/project/tests/hooks/post-tool-use.ts",
      "/test/project/tests/stop.test.ts",
      "/test/project/tests/user-prompt-submit.test.ts",
      "/test/project/tests/post-tool-use.test.ts",
      "/test/project/tests/pre-tool-use.test.ts",
      "/test/project/schemas/hooks.ts",
      "/test/project/schemas/tools.ts",
      "/test/project/tests/inputs/inputs.test.ts",
    ],
    numFiles: 26,
    truncated: false,
  },
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
  type: "Glob",
}
`;

snapshot[`parse PostToolUse.Bash.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "PostToolUse",
  permission_mode: "bypassPermissions",
  session_id: "test-session-id",
  tool_input: {
    command: "pwd",
    description: "Print working directory",
  },
  tool_name: "Bash",
  tool_response: {
    interrupted: false,
    isImage: false,
    stderr: "",
    stdout: "/test/project",
  },
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
  type: "Bash",
}
`;

snapshot[`parse PostToolUse.Grep.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "PostToolUse",
  permission_mode: "bypassPermissions",
  session_id: "test-session-id",
  tool_input: {
    pattern: "export",
  },
  tool_name: "Grep",
  tool_response: {
    filenames: [
      "/test/project/tests/inputs/PreToolUse.Grep.json",
      "/test/project/scripts/gen-hook-inputs.sh",
      "/test/project/tests/inputs/__snapshots__/inputs.test.ts.snap",
      "/test/project/schemas/tools.ts",
      "/test/project/schemas/hooks.ts",
      "/test/project/deno.json",
      "/test/project/mod.ts",
      "/test/project/.beads/.gitignore",
      "/test/project/testing.ts",
      "/test/project/define-hook.ts",
      "/test/project/mod.test.ts",
      "/test/project/env.ts",
      "/test/project/.beads/metadata.json",
    ],
    mode: "files_with_matches",
    numFiles: 13,
  },
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
  type: "Grep",
}
`;

snapshot[`parse PostToolUse.Task.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "PostToolUse",
  permission_mode: "bypassPermissions",
  session_id: "test-session-id",
  tool_input: {
    description: "test task",
    model: "haiku",
    prompt: "What is 2+2?",
    subagent_type: "general-purpose",
  },
  tool_name: "Task",
  tool_response: {
    agentId: "ca8e0ee5",
    content: [
      {
        text: "2 + 2 = 4

This is a straightforward arithmetic question. Is there anything else I can help you with regarding your Deno Claude Code hook project?",
        type: "text",
      },
    ],
    prompt: "What is 2+2?",
    status: "completed",
    totalDurationMs: 2785,
    totalTokens: 23876,
    totalToolUseCount: 0,
    usage: {
      cache_creation: {
        ephemeral_1h_input_tokens: 0,
        ephemeral_5m_input_tokens: 23832,
      },
      cache_creation_input_tokens: 23832,
      cache_read_input_tokens: 0,
      input_tokens: 3,
      output_tokens: 41,
      service_tier: "standard",
    },
  },
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
  type: "Task",
}
`;

snapshot[`parse PostToolUse.NotebookEdit.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "PostToolUse",
  permission_mode: "bypassPermissions",
  session_id: "test-session-id",
  tool_input: {
    cell_id: "test-cell-1",
    new_source: "print(1)",
    notebook_path: "/tmp/test-notebook-edit.ipynb",
  },
  tool_name: "NotebookEdit",
  tool_response: {
    cell_id: "test-cell-1",
    cell_type: "code",
    edit_mode: "replace",
    error: "",
    language: "python",
    new_source: "print(1)",
  },
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
  type: "NotebookEdit",
}
`;

snapshot[`parse PostToolUse.TodoWrite.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "PostToolUse",
  permission_mode: "bypassPermissions",
  session_id: "test-session-id",
  tool_input: {
    todos: [
      {
        activeForm: "Testing task",
        content: "test task",
        status: "pending",
      },
    ],
  },
  tool_name: "TodoWrite",
  tool_response: {
    newTodos: [
      {
        activeForm: "Testing task",
        content: "test task",
        status: "pending",
      },
    ],
    oldTodos: [],
  },
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
  type: "TodoWrite",
}
`;

snapshot[`parse PostToolUse.WebFetch.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "PostToolUse",
  permission_mode: "bypassPermissions",
  session_id: "test-session-id",
  tool_input: {
    prompt: "extract the page title",
    url: "https://example.com",
  },
  tool_name: "WebFetch",
  tool_response: {
    bytes: 513,
    code: 200,
    codeText: "OK",
    durationMs: 3210,
    result: '# Page Title

The page title is **"Example Domain"**

This appears in both the heading structure and serves as the primary heading on the page, which reads: "This domain is for use in documentation examples without needing permission."',
    url: "https://example.com",
  },
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
  type: "WebFetch",
}
`;

snapshot[`parse PostToolUse.WebSearch.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "PostToolUse",
  permission_mode: "bypassPermissions",
  session_id: "test-session-id",
  tool_input: {
    query: "Claude Code hooks documentation",
  },
  tool_name: "WebSearch",
  tool_response: {
    durationSeconds: 10.594157542000001,
    query: "Claude Code hooks documentation",
    results: [
      {
        content: [
          {
            title: "Get started with Claude Code hooks - Claude Code Docs",
            url: "https://docs.claude.com/en/docs/claude-code/hooks-guide",
          },
          {
            title: "Hooks reference - Claude Docs",
            url: "https://docs.claude.com/en/docs/claude-code/hooks",
          },
          {
            title: "GitHub - disler/claude-code-hooks-mastery",
            url: "https://github.com/disler/claude-code-hooks-mastery",
          },
          {
            title: "ClaudeLog - Claude Code Docs, Guides, Tutorials & Best Practices",
            url: "https://claudelog.com/mechanics/hooks/",
          },
          {
            title: "Claude Code Hooks | GitButler Docs",
            url: "https://docs.gitbutler.com/features/ai-integration/claude-code-hooks",
          },
          {
            title: "What is Claude Code Hooks and How to Use It",
            url: "https://apidog.com/blog/claude-code-hooks/",
          },
          {
            title: "Automate Your AI Workflows with Claude Code Hooks | Butler's Log",
            url: "https://blog.gitbutler.com/automate-your-ai-workflows-with-claude-code-hooks",
          },
          {
            title: "How Iâ€™m Using Claude Code Hooks (Newest Feature) To Fully Automate My Workflow",
            url: "https://medium.com/@joe.njenga/use-claude-code-hooks-newest-feature-to-fully-automate-your-workflow-341b9400cfbe",
          },
          {
            title: "GitHub - disler/claude-code-hooks-multi-agent-observability: Real-time monitoring for Claude Code agents through simple hook event tracking.",
            url: "https://github.com/disler/claude-code-hooks-multi-agent-observability",
          },
          {
            title: "GitHub - decider/claude-hooks: Comprehensive hooks for Claude Code to enforce clean code practices and automate workflows",
            url: "https://github.com/decider/claude-hooks",
          },
        ],
        tool_use_id: "srvtoolu_01J9LMfaPwBFoYw3DYvCn14E",
      },
      "I've found comprehensive documentation on Claude Code hooks. Here's what the search results reveal:

## Official Claude Code Hooks Documentation

This page provides reference documentation for implementing hooks in Claude Code, with a quickstart guide and examples available.

### What Are Hooks?

Claude Code Hooks are user-defined shell commands that execute automatically at specific points in Claude Code's lifecycle, acting as triggers that you can configure to fire before or after certain actions. Hooks provide deterministic, programmatic control over Claude Code's behavior, ensuring certain actions always happen rather than relying on the LLM to choose to run them.

### Hook Events

Claude Code provides several hook events that run at different points in the workflow, including PreToolUse (runs before tool calls and can block them) and SessionEnd (runs when Claude Code session ends).

### Configuration

Claude Code hooks are configured in your settings files with a structure that includes EventName, a matcher pattern to match tool names, and the hooks array.

### Security Considerations

You must consider the security implications of hooks as they run automatically during the agent loop with your current environment's credentials, and you should always review your hooks implementation before registering them.

### Recent Features

Starting in v2.0.10, PreToolUse hooks can modify tool inputs before execution by intercepting tool calls and modifying the JSON input, letting execution proceed with corrected parameters.

The official documentation is available at **https://docs.claude.com/en/docs/claude-code/hooks-guide** and **https://docs.claude.com/en/docs/claude-code/hooks** for the reference documentation.",
    ],
  },
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
  type: "WebSearch",
}
`;

snapshot[`parse PostToolUse.SlashCommand.json 1`] = `
{
  cwd: "/test/project",
  hook_event_name: "PostToolUse",
  permission_mode: "bypassPermissions",
  session_id: "test-session-id",
  tool_input: {
    command: "/test-command",
  },
  tool_name: "SlashCommand",
  tool_response: {
    commandName: "test-command",
    success: true,
  },
  transcript_path: "/test/project/.claude/transcripts/test-session.json",
  type: "SlashCommand",
}
`;

snapshot[`parse PostToolUse.BashOutput.json 1`] = `
{
  cwd: "/Users/chris/src/chrisbarrett/deno-claude-code-hook",
  hook_event_name: "PostToolUse",
  permission_mode: "bypassPermissions",
  session_id: "b6e655f9-604a-4c74-b08d-c6231a11a4ed",
  tool_input: {
    bash_id: "c26bed",
  },
  tool_name: "BashOutput",
  tool_response: {
    command: "sleep 30 && echo done",
    exitCode: null,
    shellId: "c26bed",
    status: "running",
    stderr: "",
    stderrLines: 1,
    stdout: "",
    stdoutLines: 1,
    timestamp: "2025-11-14T09:15:08.128Z",
  },
  transcript_path: "/Users/chris/.claude/projects/-Users-chris-src-chrisbarrett-deno-claude-code-hook/b6e655f9-604a-4c74-b08d-c6231a11a4ed.jsonl",
  type: "BashOutput",
}
`;

snapshot[`parse PostToolUse.KillShell.json 1`] = `
{
  cwd: "/Users/chris/src/chrisbarrett/deno-claude-code-hook",
  hook_event_name: "PostToolUse",
  permission_mode: "bypassPermissions",
  session_id: "b6e655f9-604a-4c74-b08d-c6231a11a4ed",
  tool_input: {
    shell_id: "c26bed",
  },
  tool_name: "KillShell",
  tool_response: {
    message: "Successfully killed shell: c26bed (sleep 30 && echo done)",
    shell_id: "c26bed",
  },
  transcript_path: "/Users/chris/.claude/projects/-Users-chris-src-chrisbarrett-deno-claude-code-hook/b6e655f9-604a-4c74-b08d-c6231a11a4ed.jsonl",
  type: "KillShell",
}
`;
