# @chrisbarrett/claude-code-hook

Type-safe Deno library for building [Claude Code](https://code.claude.com) hooks
with runtime validation. Using this lib you can write self-contained hook
scripts with LSP completions and editor squiggles to guide you.

## Quick Start

The example below will teach Claude Code to use the `say` command on macOS to
announce when it's compacting. The announcement is a bit terser if compaction
was user-initiated via `/compact`.

```typescript
#!/usr/bin/env -S deno run --allow-read --allow-run
import { preCompact } from "jsr:@chrisbarrett/claude-code-hook";
import $ from "jsr:@david/dax";

preCompact(async (input) => {
  const message = input.trigger === "auto"
    ? "Auto-compaction started"
    : "Compacting";

  await $`nohup -- say ${message}`;
});
```

Don't forget to `chmod +x`!

**Configure in `~/.claude/settings.json`:**

```json
{
  "hooks": {
    "PreCompact": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "/path/to/your/script"
          }
        ]
      }
    ]
  }
}
```

## Features

- **Type-safe** - Full TypeScript types for all hook inputs and outputs
- **Validated** - Zod schemas ensure runtime type safety
- **Zero config** - Handles all stdin/stdout/JSON serialization

## Prerequisites

Make sure you have Deno installed, then get scripting! Your
`~/.claude/settings.json` file is how you teach Claude Code to run your scripts
on hook events; see the
[Claude Code hooks documentation](https://code.claude.com/docs/en/hooks) to get
started.

## Permissions

Hooks require explicit Deno permissions. See the
[Deno permissions documentation](https://docs.deno.com/runtime/fundamentals/security/)
for more details.

| Permission      | Purpose                                 | Required |
| --------------- | --------------------------------------- | -------- |
| `--allow-read`  | Read from stdin                         | Always   |
| `--allow-write` | File operations (e.g., `persistEnvVar`) | Optional |
| `--allow-env`   | Access environment variables            | Optional |
| `--allow-run`   | Execute shell commands (e.g., dax)      | Optional |
| `--allow-net`   | Network requests (e.g., `fetch`)        | Optional |

<!-- prettier-ignore-start -->

> [!TIP]
> Claude Code passes input via stdin; your hooks will invariable require
> `--allow-read`.

<!-- prettier-ignore-end -->

## Examples

These are contrived examples generated by Claude Code, but you get the idea. :)

### Load Project Context on Session Start

```typescript
import { sessionStart } from "jsr:@chrisbarrett/claude-code-hook";
import $ from "jsr:@david/dax";

sessionStart(async (input) => {
  const branch = await $`git branch --show-current`.text();
  const commits = await $`git log -5 --oneline`.text();

  return {
    hookSpecificOutput: {
      hookEventName: "SessionStart",
      additionalContext: `
Branch: ${branch}

Recent commits:
${commits}
      `.trim(),
    },
  };
});
```

### Block Dangerous File Operations

```typescript
import { preToolUse } from "jsr:@chrisbarrett/claude-code-hook";

preToolUse(async (input) => {
  if (input.tool_name === "Write" || input.tool_name === "Edit") {
    if (input.tool_input.file_path.includes(".env")) {
      return {
        hookSpecificOutput: {
          hookEventName: "PreToolUse",
          shouldProceed: false,
          blockedMessage: "No secrets for you!",
        },
      };
    }
  }
});
```

### Set Session-Level Environment Variables

```typescript
import {
  persistEnvVar,
  sessionStart,
} from "jsr:@chrisbarrett/claude-code-hook";

sessionStart(async (input) => {
  await persistEnvVar("SOME_SESSION_VARIABLE", "hello from Session Start!");
});
```

Subsequent hooks in your session can then use
`Deno.env.get("SOME_SESSION_VARIABLE")` to retrieve that value.

## Hook Return Values

Most hooks return either `void` or an object with `hookSpecificOutput`. Let the
types guide you.

```typescript
// Void return (no output)
sessionStart(async (input) => {
  console.log("Session started");
  // No return needed
});

// With output
sessionStart(async (input) => {
  return {
    hookSpecificOutput: {
      hookEventName: "SessionStart",
      additionalContext: "Your context here",
    },
  };
});

// Blocking (PreToolUse, UserPromptSubmit)
preToolUse(async (input) => {
  return {
    hookSpecificOutput: {
      hookEventName: "PreToolUse",
      shouldProceed: false,
      blockedMessage: "Operation not allowed",
    },
  };
});

// Force continuation (Stop, SubagentStop)
stop(async (input) => {
  return {
    hookSpecificOutput: {
      hookEventName: "Stop",
      mustContinue: true,
      additionalContext: "Please continue with next steps",
    },
  };
});
```

## Type-safe Tool Call Inspections

Check the `type` of a tool to get type-safe access to its inputs.

```typescript
import { preToolUse } from "jsr:@chrisbarrett/claude-code-hook";

preToolUse(async (input) => {
  // TypeScript knows the shape based on tool_name
  if (input.type === "Read") {
    // input.tool_input.file_path is typed
    const path = input.tool_input.file_path;
  } else if (input.type === "Edit") {
    // input.tool_input has file_path, old_string, new_string
    const { file_path, old_string, new_string } = input.tool_input;
  }
});
```

A number of the built-in tools have types defined for their inputs; for
everything else you can fall back on `input.type === "Unknown"`; you might like
to use Zod schemas to validate such tools. ;)

<!-- prettier-ignore-start -->

> [!CAUTION]
> Anthropic doesn't officially document their tools, so don't be surprised if
> these types become broken after a future Claude Code update.

<!-- prettier-ignore-end -->

## Environment Variables

<!-- prettier-ignore-start -->

> [!IMPORTANT]
> Don't forget about Deno's permissions model! You must grant your hooks access
> to the process environment explicitly using `--allow-env` & friends.

<!-- prettier-ignore-end -->

### CLAUDE_CODE_HOOK_STDIN_MAX_BUF_LEN

Controls maximum buffer size (in bytes) for stdin reads. It's set to 10 MiB as
an arbitrary default; you might want to override this if you have monstrous tool
call payloads.

```bash
export CLAUDE_CODE_HOOK_STDIN_MAX_BUF_LEN=$(( 1024 ** 3 ))  # 1 GiB.
```

RIP your context if you ever need to do this.

### CLAUDE_ENV_FILE

This variable is set automatically by Claude Code in `SessionStart` hooks. You
can write to this file to define environment variables available in the scope of
the current session

<!-- prettier-ignore-start -->

> [!IMPORTANT]
> `CLAUDE_ENV_FILE` is only available in `SessionStart` hooks.

<!-- prettier-ignore-end -->

The `persistEnvVar()` function can be used to append values to this file.

## Claude Code Documentation

For comprehensive hook documentation, see the
[official Claude Code hooks guide](https://code.claude.com/docs/en/hooks).

## License

MIT
